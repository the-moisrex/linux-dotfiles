#!/bin/bash
set -euo pipefail

# Function to display help
show_help() {
    cat << EOF
Usage: $0 [ENGINE_SHORTCUTS...] <search query>

Generate search URLs for multiple search engines.

(Short help omitted for brevity — refer to original script for full usage.)
EOF
}

# Basic checks
if [ $# -eq 0 ]; then
    show_help
    exit 1
fi
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
    exit 0
fi

# --- Engine URL mappings (extended) ---
declare -A engine_urls=(
    ["google"]="https://www.google.com/search?q="
    ["bing"]="https://www.bing.com/search?q="
    ["duckduckgo"]="https://duckduckgo.com/?q="
    ["startpage"]="https://www.startpage.com/sp/search?query="
    ["perplexity"]="https://www.perplexity.ai/search?q="
    ["yahoo"]="https://search.yahoo.com/search?p="
    ["brave"]="https://search.brave.com/search?q="
    ["qwant"]="https://www.qwant.com/?q="
    ["ecosia"]="https://www.ecosia.org/search?q="
    ["wolframalpha"]="https://www.wolframalpha.com/input/?i="
    ["yandex"]="https://yandex.com/search/?text="
    ["baidu"]="https://www.baidu.com/s?wd="
    ["chatgpt"]="https://chatgpt.com/?q="
    ["swisscows"]="https://swisscows.com/en/web?query="
    ["mojeek"]="https://www.mojeek.com/search?q="
    ["searxng"]="http://localhost:8080/search?q="
    ["hackernews"]="https://hn.algolia.com/?query="
    ["reddit"]="https://www.reddit.com/search/?q="
    ["techcrunch"]="https://techcrunch.com/search/?s="
    ["arstechnica"]="https://arstechnica.com/search/"
    ["scholar"]="https://scholar.google.com/scholar?q="
    ["twitter"]="https://twitter.com/search?q="
    ["facebook"]="https://www.facebook.com/search/top/?q="
    ["github"]="https://github.com/search?q="
    ["stackoverflow"]="https://stackoverflow.com/search?q="
    ["aljazeera"]="https://www.aljazeera.com/search/"
    ["rt"]="https://www.rt.com/search?q="
    ["cnn"]="https://edition.cnn.com/search?q="
    ["foxnews"]="https://www.foxnews.com/search-results/search#q="
    ["google-news"]="https://news.google.com/search?hl=en-US&gl=US&q="
    ["bing-news"]="https://www.bing.com/news/search?q="
    ["devdocs"]="https://devdocs.io/#q="
    ["youtube"]="https://www.youtube.com/results?search_query="
    ["deepseek"]="https://chat.deepseek.com/"
    ["usersearch"]="https://usersearch.ai/"
    ["qwen"]="https://chat.qwen.ai/"
    ["phind"]="https://www.phind.com/"
    ["grokipedia"]="https://grokipedia.com/search?q="
    ["devdocs-cpp"]="https://devdocs.io/cpp/#q="
    ["devdocs-html"]="https://devdocs.io/html/#q="
    ["devdocs-css"]="https://devdocs.io/css/#q="
    ["devdocs-javascript"]="https://devdocs.io/javascript/#q="
    ["mdn"]="https://developer.mozilla.org/en-US/search?q="
    # --- Added engines/sites for advanced heuristics ---
    ["wttr"]="https://wttr.in/"
    ["timeis"]="https://time.is/"
    ["imdb"]="https://www.imdb.com/find?q="
    ["letterboxd"]="https://letterboxd.com/search/films/"
    ["genius"]="https://genius.com/search?q="
    ["pubchem"]="https://pubchem.ncbi.nlm.nih.gov/#query="
    ["pubmed"]="https://pubmed.ncbi.nlm.nih.gov/?term="
    ["arxiv"]="https://arxiv.org/search/?query="
    ["coingecko"]="https://www.coingecko.com/en/search?query="
    ["etherscan"]="https://etherscan.io/search?search="
    ["tradingview"]="https://www.tradingview.com/symbols/"
    ["xe"]="https://www.xe.com/currencyconverter/convert/?Amount=1&From="
    ["google-books"]="https://www.google.com/search?tbm=bks&q="
    ["allrecipes"]="https://www.allrecipes.com/search/results/?wt="
    ["foodnetwork"]="https://www.foodnetwork.com/search/"
    ["regex101"]="https://regex101.com/?q="
    ["whois"]="https://who.is/whois/"
    ["shodan"]="https://www.shodan.io/search?query="
    ["coinmarketcap"]="https://coinmarketcap.com/search/?q="
    ["wikipedia"]="https://en.wikipedia.org/w/index.php?search="
    ["stackoverflow-search"]="https://stackoverflow.com/search?q="
    ["wiktionary"]="https://www.wiktionary.org/search?word="
    ["pubmed-simple"]="https://pubmed.ncbi.nlm.nih.gov/?term="
)

# --- Categories & shortcuts (same as original, extended) ---
declare -A categories=(
    ["ai"]="perplexity chatgpt"
    ["news"]="google bing yahoo yandex aljazeera rt cnn foxnews google-news bing-news"
    ["tech"]="google techcrunch arstechnica"
    ["hacker-news"]="hackernews reddit techcrunch arstechnica"
    ["academic"]="scholar pubmed arxiv"
    ["privacy"]="duckduckgo startpage brave ecosia searxng mojeek"
    ["social"]="reddit twitter facebook"
    ["code"]="github stackoverflow devdocs"
    ["video"]="youtube"
    ["ai-tools"]="deepseek usersearch qwen phind"
    ["cpp"]="stackoverflow devdocs-cpp"
    ["html"]="stackoverflow devdocs-html mdn"
    ["css"]="stackoverflow devdocs-css mdn"
    ["javascript"]="stackoverflow devdocs-javascript mdn"
    ["recipes"]="allrecipes foodnetwork youtube"
)

declare -A shortcuts=(
    ["g"]="google" ["google"]="google"
    ["b"]="bing" ["bing"]="bing"
    ["d"]="duckduckgo" ["ddg"]="duckduckgo"
    ["s"]="startpage" ["start"]="startpage"
    ["p"]="perplexity" ["per"]="perplexity"
    ["c"]="chatgpt" ["chat"]="chatgpt" ["gpt"]="chatgpt"
    ["y"]="yahoo"
    ["br"]="brave"
    ["q"]="qwant"
    ["e"]="ecosia"
    ["w"]="wolframalpha" ["wolfram"]="wolframalpha"
    ["ya"]="yandex"
    ["bd"]="baidu"
    ["sw"]="swisscows"
    ["m"]="mojeek"
    ["sx"]="searxng"
    ["hn"]="hacker-news"
    ["ai"]="ai"
    ["news"]="news"
    ["code"]="code"
    ["cpp"]="cpp"
    ["html"]="html"
    ["css"]="css"
    ["javascript"]="javascript"
    ["recipe"]="recipes"
    ["all"]="all"
)

# helper: check searxng running
is_searxng_running() {
    if command -v curl >/dev/null 2>&1; then
        curl -s --max-time 1 http://localhost:8080/ >/dev/null 2>&1
        return $?
    elif command -v wget >/dev/null 2>&1; then
        wget --timeout=1 -q --spider http://localhost:8080/ 2>/dev/null
        return $?
    else
        return 1
    fi
}

# default engines
default_engines=("google" "bing" "duckduckgo" "startpage" "swisscows" "mojeek")
if is_searxng_running; then
    default_engines+=("searxng")
fi

# URL-encode function (python3)
encode_query() {
    python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$1"
}

# argument parsing (engines vs query)
engines=()
query_parts=()
processing_engines=true
all_engines=false

for arg in "$@"; do
    if [ "$processing_engines" = true ]; then
        if [ -n "${shortcuts[$arg]:-}" ]; then
            target="${shortcuts[$arg]}"
            if [ "$target" = "all" ]; then
                all_engines=true
            elif [ -n "${categories[$target]:-}" ]; then
                for e in ${categories[$target]}; do
                    [[ " ${engines[*]} " == *" $e "* ]] || engines+=("$e")
                done
            else
                [[ " ${engines[*]} " == *" $target "* ]] || engines+=("$target")
            fi
        else
            processing_engines=false
            query_parts+=("$arg")
        fi
    else
        query_parts+=("$arg")
    fi
done

query="${query_parts[*]}"

# Read from stdin if empty
if [ -z "$query" ]; then
    if [ ! -t 0 ]; then
        query=$(cat | xargs)
    fi
fi

if [ -z "$query" ]; then
    echo "Error: No search query provided" >&2
    show_help
    exit 1
fi

# If user explicitly asked for all engines
if [ "$all_engines" = true ]; then
    engines=("${!engine_urls[@]}")
fi

# If user provided explicit engines, keep them. Otherwise run the mega heuristics.
if [ "${#engines[@]}" -eq 0 ]; then
    # Start heuristics
    lc_query=$(echo "$query" | tr '[:upper:]' '[:lower:]')

    # Helper functions for pattern checks
    is_doi() {
        # rough DOI detection e.g. 10.1000/xyz123
        echo "$1" | grep -E -q '10\.[0-9]{4,9}/[-._;()/:A-Za-z0-9]+'
    }
    is_arxiv() {
        echo "$1" | grep -E -q '(arxiv:|[0-9]{4}\.[0-9]{4,5}|[a-z-]+/[0-9]{7})'
    }
    is_isbn() {
        echo "$1" | grep -E -q '((97(8|9))?[0-9]{9}([0-9]|X))'
    }
    is_ip() {
        echo "$1" | grep -E -q '(^|[^0-9])((25[0-5]|2[0-4][0-9]|[01]?[0-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9]?[0-9])([^0-9]|$)'
    }
    is_url() {
        echo "$1" | grep -E -q 'https?://|www\.[A-Za-z0-9.-]+\.[A-Za-z]{2,}'
    }
    is_email() {
        echo "$1" | grep -E -q '[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}'
    }
    is_eth_addr() {
        # rough ETH address: 0x + 40 hex
        echo "$1" | grep -E -q '0x[0-9a-fA-F]{40}'
    }
    is_btc_addr() {
        # rough: starts with 1,3 or bc1 and length conditions
        echo "$1" | grep -E -q '\b(1|3)[A-HJ-NP-Za-km-z1-9]{25,34}\b|\bbc1[a-z0-9]{11,71}\b'
    }
    is_txhash() {
        echo "$1" | grep -E -q '\b0x[0-9a-fA-F]{64}\b'
    }
    is_flight() {
        echo "$1" | grep -E -q '\b[a-zA-Z]{2}\s?[0-9]{1,4}\b'
    }
    is_stock_ticker() {
        # $TICKER or uppercase 1-5 letters with optional dot/-
        echo "$1" | grep -E -q '(^|\s)\$[A-Za-z]{1,5}(\b|$)|(^|\s)[A-Z]{1,5}(\b|$)'
    }
    is_latex() {
        echo "$1" | grep -E -q '\\\\(frac|sqrt|sum|int)|\$\$|\\begin\{'
    }
    is_math_expr() {
        # contains = and digits/operators or math words
        echo "$1" | grep -E -q '[0-9]+\s*[\+\-\*\/\^]\s*[0-9]+|='
    }
    is_regex_pattern() {
        echo "$1" | grep -E -q '^\^|\\d|\[.+\]|\(\?:'
    }
    is_stacktrace() {
        echo "$1" | grep -E -q 'traceback|exception|at [A-Za-z0-9_.\$]+|\.java:|\.cpp:|segfault|stacktrace'
    }
    is_command_snippet() {
        echo "$1" | grep -E -q '(^|;|\\n)(ls |grep |chmod |sudo |apt |yum |brew |pip |npm |cargo |go )'
    }
    is_recipe() {
        echo "$lc_query" | grep -E -q 'recipe|how to cook|how to make|bake|grill|roast|ingredients'
    }
    is_movie_or_show() {
        echo "$lc_query" | grep -E -q 'movie|film|trailer|cast|imdb|episode|season|watch'
    }
    is_music_or_lyrics() {
        echo "$lc_query" | grep -E -q 'lyrics|song by|sing|track|album|spotify|genius'
    }
    is_weather() {
        echo "$lc_query" | grep -E -q 'weather|rain|snow|forecast|temperature|°c|°f|°'
    }
    is_time_query() {
        echo "$lc_query" | grep -E -q 'what time|time in|current time|local time|timezone|utc\+|-'
    }
    is_currency_or_fx() {
        echo "$lc_query" | grep -E -q '\$|€|£|yen|usd|eur|gbp|exchange rate|forex|convert'
    }
    is_recipe_file_ext() {
        false
    }
    is_medical_symptom() {
        echo "$lc_query" | grep -E -q 'fever|cough|pain|headache|nausea|shortness of breath|chest pain'
    }
    is_hardware_model() {
        echo "$1" | grep -E -q '[A-Za-z]{2,}-[A-Za-z0-9]{2,}|[A-Za-z0-9]{2,}\s?(Pro|Max|Mini|Plus|Ultra)\b'
    }
    is_isbn_query() {
        is_isbn "$query"
    }

    # 1) Very strong format matches first (addresses, DOIs, arXiv, ISBN, URL, email, IP)
    if is_doi "$query"; then
        engines=("scholar" "arxiv" "google")
        reason="DOI"
    elif is_arxiv "$query"; then
        engines=("arxiv" "scholar" "google")
        reason="arXiv"
    elif is_isbn "$query"; then
        engines=("google-books" "wikipedia" "google")
        reason="ISBN"
    elif is_txhash "$query" || is_eth_addr "$query" || is_btc_addr "$query"; then
        # crypto address or tx hash
        engines=("etherscan" "coingecko" "coinmarketcap" "google")
        reason="Crypto address/txhash"
    elif is_url "$query"; then
        # domain/URL
        engines=("whois" "google" "bing" "shodan")
        reason="URL/domain"
    elif is_email "$query"; then
        engines=("google" "wikipedia")
        reason="Email"
    elif is_ip "$query"; then
        engines=("shodan" "whois" "google")
        reason="IP"
    # 2) Flight numbers
    elif is_flight "$query" && echo "$lc_query" | grep -E -q 'flight|arrival|departure|airlines|gate'; then
        engines=("google" "flightaware" "google")
        reason="Flight"
    # 3) Stock ticker / finance
    elif is_stock_ticker "$query" && echo "$lc_query" | grep -E -q 'stock|share|ticker|price|ipo|market|earnings|dividend'; then
        engines=("tradingview" "google" "yahoo")
        reason="Stock/finance"
    # 4) Mathematics / LaTeX / equations
    elif is_latex "$query" || is_math_expr "$query"; then
        engines=("wolframalpha" "google" "scholar")
        reason="Math/LaTeX"
    # 5) Regex pattern
    elif is_regex_pattern "$query"; then
        engines=("regex101" "stackoverflow")
        reason="Regex"
    # 6) Stack traces/errors/compilation problems
    elif is_stacktrace "$query" || echo "$lc_query" | grep -q -E 'error:|fatal:|segmentation fault|undefined reference'; then
        engines=("stackoverflow" "github" "google")
        reason="Error/Stacktrace"
    # 7) Command snippet / shell / manpage lookups
    elif is_command_snippet "$query" || echo "$lc_query" | grep -q -E 'man page|manpage|how to use .*command'; then
        engines=("google" "devdocs" "stackoverflow" "wikipedia")
        reason="Commands/CLI"
    # 8) Programming language / framework detection (keywords)
    elif echo "$lc_query" | grep -q -E '\bpython\b'; then
        engines=("devdocs" "stackoverflow" "github" "google")
        reason="Python"
    elif echo "$lc_query" | grep -q -E '\brust\b'; then
        engines=("github" "stackoverflow" "google")
        reason="Rust"
    elif echo "$lc_query" | grep -q -E '\bgo(lang)?\b'; then
        engines=("devdocs" "github" "stackoverflow" "google")
        reason="Go"
    elif echo "$lc_query" | grep -q -E '\bjava\b'; then
        engines=("stackoverflow" "github" "google")
        reason="Java"
    elif echo "$lc_query" | grep -q -E '\bjavascript\b|\bnode\b|npm|react|vue|angular'; then
        engines=("devdocs-javascript" "mdn" "stackoverflow" "github")
        reason="JavaScript/Frontend"
    elif echo "$lc_query" | grep -q -E 'std::|c\+\+|cpp|#include|g\+\+'; then
        engines=("devdocs-cpp" "stackoverflow" "google")
        reason="C++"
    # 9) Recipes / food / how-to-cook
    elif is_recipe; then
        engines=("allrecipes" "foodnetwork" "youtube" "google")
        reason="Recipe"
    # 10) Movies / TV / shows
    elif is_movie_or_show; then
        engines=("imdb" "letterboxd" "youtube" "google")
        reason="Movies/TV"
    # 11) Music / lyrics
    elif is_music_or_lyrics; then
        engines=("genius" "youtube" "google")
        reason="Music/Lyrics"
    # 12) Weather/time/currency
    elif is_weather; then
        engines=("wttr" "google")
        reason="Weather"
    elif is_time_query; then
        engines=("timeis" "google")
        reason="Time"
    elif is_currency_or_fx; then
        engines=("xe" "google" "tradingview")
        reason="Currency/FX"
    # 13) Medical symptoms — not a diagnosis; point to reputable health sources
    elif is_medical_symptom; then
        engines=("google" "pubmed" "wikipedia")
        reason="Medical symptoms (informational)"
    # 14) Hardware / product model
    elif is_hardware_model "$query"; then
        engines=("google" "amazon" "wikipedia")
        reason="Hardware/Product"
    # 15) Generic code/help queries (how-to/example/etc.)
    elif echo "$lc_query" | grep -q -E 'how to|how do i|example|snippet|tutorial|best way to|what is the best'; then
        engines=("google" "stackoverflow" "devdocs" "youtube")
        reason="How-to/Example"
    # 16) Short queries that look like named entities (country/city/person) -> news + wikipedia
    elif echo "$lc_query" | grep -q -E '^[a-z]{2,}( [a-z]{2,})?$' && [ ${#lc_query} -le 40 ]; then
        engines=("wikipedia" "google-news" "google" "bing-news")
        reason="Named entity (short)"
    else
        # fallback default set
        engines=("${default_engines[@]}")
        reason="Fallback default"
    fi

    # Remove duplicates while preserving order
    unique_engines=()
    for e in "${engines[@]}"; do
        if [ -n "${engine_urls[$e]:-}" ]; then
            if [[ ! " ${unique_engines[*]} " =~ " $e " ]]; then
                unique_engines+=("$e")
            fi
        fi
    done
    engines=("${unique_engines[@]}")

    # Print auto-selection reason to stderr for transparency
    # >&2 echo "# auto-selected ($reason): ${engines[*]}"
fi

# Ensure at least one engine
if [ ${#engines[@]} -eq 0 ]; then
    engines=("${default_engines[@]}")
fi

# URL-encode the query; special-case DDG bangs:
if [[ "${query:0:1}" == "!" ]]; then
    bang="!"
    rest="${query:1}"
    encoded_rest=$(encode_query "$rest")
    ddg_query="${bang}${encoded_rest}"
    encoded_query="$ddg_query"
else
    encoded_query=$(encode_query "$query")
fi

# Print the search URLs
for engine in "${engines[@]}"; do
    urlbase="${engine_urls[$engine]:-}"
    if [ -z "$urlbase" ]; then
        continue
    fi
    # Special handling for engines that prefer different URL shapes:
    case "$engine" in
        xe)
            # XE: use currency pairs if query contains "USD to EUR" or similar
            if echo "$lc_query" | grep -qE '([A-Za-z]{3}) to ([A-Za-z]{3})'; then
                from=$(echo "$lc_query" | sed -nE 's/.*([A-Za-z]{3}) to ([A-Za-z]{3}).*/\1/p' | tr '[:lower:]' '[:upper:]')
                to=$(echo "$lc_query" | sed -nE 's/.*([A-Za-z]{3}) to ([A-Za-z]{3}).*/\2/p' | tr '[:lower:]' '[:upper:]')
                if [ -n "$from" ] && [ -n "$to" ]; then
                    echo "https://www.xe.com/currencyconverter/convert/?Amount=1&From=${from}&To=${to}"
                    continue
                fi
            fi
            echo "${urlbase}${encoded_query}"
            ;;
        *)
            echo "${urlbase}${encoded_query}"
            ;;
    esac
done

