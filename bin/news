#!/bin/bash

# Determine the directory of the script and set the path to the 'urls' command
SCRIPT_DIR=$(dirname "$0")
URLS_CMD="$SCRIPT_DIR/urls"

# Default curl options with a user-agent to mimic a browser
CURL_OPTIONS="-sL -A 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'"

# Global exclude patterns for common file types and social media links
GLOBAL_EXCLUDE_PATTERNS=(
    "\\.jpg" "\\.png" "\\.gif" "\\.bmp" "\\.tiff" "\\.webp"
    "\\.pdf" "\\.zip" "\\.tar" "\\.gz" "\\.rar" "\\.7z"
    "\\.exe" "\\.dll" "\\.mp3" "\\.mp4" "\\.avi" "\\.mkv"
    "\\.mov" "\\.wmv" "\\.flv" "\\.swf" "\\.css" "\\.js"
    "\\.xml" "\\.json" "\\.txt" "\\.log" "\\.ico" "\\.svg"
    "\\.woff" "\\.woff2" "\\.ttf" "\\.otf" "\\.eot"
    "t\\.me" "facebook\\.com" "twitter\\.com" "instagram\\.com"
    "linkedin\\.com" "pinterest\\.com" "reddit\\.com" "youtube\\.com"
    "twitch\\.tv" "tiktok\\.com"
    "google\\.com" "googletagmanager\\.com" "aparat\\.com"
    "rubika\\.ir" "splus\\.ir" "tamasha\\.com" "tapsi\\.ir"
    "javascript:void\\(0\\)" "gap\\.im" "w3\\.org" "ogp\\.me" "schema\\.org"
    "ble\\.ir" "x\\.com" "data:image" "eitaa\\.com" "#" "\\.m3u8"
)

# Combine global exclude patterns into a single regex
EXCLUDE_REGEX=$(IFS='|'; echo "${GLOBAL_EXCLUDE_PATTERNS[*]}")

# Function to display help information
show_help() {
    echo "Usage: $0 [options] <website>"
    echo
    echo "Options:"
    echo "  --help       Display this help message"
    echo "  --verbose    Enable verbose output"
    echo
    echo "Commands:"
    echo "  list         List all supported news agencies"
    echo
    echo "Examples:"
    echo "  $0 rt.com       # Fetch news URLs from rt.com"
    echo "  $0 --verbose rt  # Fetch news URLs from rt.com with verbose output"
    echo "  $0 list         # List all supported news agencies"
}

# Function to list supported news agencies
list_agencies() {
    echo "Supported news agencies:"
    echo "  rt.com (Russia Today)"
    echo "  sputnik, sputnikglobe.com (Sputnik News)"
    echo "  spnfa, spnfa.ir (Sputnik Farsi)"
    echo "  iranintl, iranintl.com (Iran International)"
    echo "  bbc-farsi, bbcfarsi, bbcpersian (BBC Persian)"
    echo "  msnbc, msnbc.com (MSNBC)"
    echo "  cnn, cnn.com (CNN)"
    echo "  cnbc, cnbc.com (CNBC)"
    echo "  cna.asia, channelnewsasia.com (Channel NewsAsia)"
    echo "  reuters, reuters.com (Reuters)"
    echo "  ap, apnews.com (Associated Press)"
    echo "  dw, dw.com (Deutsche Welle)"
    echo "  bbc, bbc.com (BBC News)"
    echo "  france24, france24.com (France 24)"
    echo "  abc, abc.com (ABC News)"
    echo "  nhk, nhk.or.jp (NHK World)"
    echo "  sky, sky.com (Sky News)"
    echo "  theguardian, theguardian.com (The Guardian)"
    echo "  afp, afp.com (Agence France-Presse)"
    echo "  trt, trtworld.com (TRT World)"
    echo "  cgtn, cgtn.com (CGTN)"
    echo "  aa, aa.com.tr (Anadolu Agency)"
    echo "  aljazeera, aljazeera.com (Al Jazeera)"
    echo "  cbs, cbsnews.com (CBS News)"
}

# Parse command-line arguments
VERBOSE=false
WEBSITE=""
COMMAND=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --help)
            show_help
            exit 0
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        list)
            list_agencies
            exit 0
            ;;
        *)
            if [ -z "$WEBSITE" ]; then
                WEBSITE=$1
            else
                echo "Error: Multiple websites specified."
                show_help
                exit 1
            fi
            shift
            ;;
    esac
done

# Check if a website was provided (unless command was 'list')
if [ -z "$WEBSITE" ]; then
    echo "Error: No website specified."
    show_help
    exit 1
fi

BASE_URL="https://$WEBSITE"
# Configure website-specific settings
case $WEBSITE in
    rt.com|rt|russia-today|rtoday|russiatoday)
        WEBSITE="rt.com"
        BASE_URL="https://rt.com"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/news"
        )
        FILTERS=(
            "grep -E \"/news/[[:digit:]]+\""
        )
        ;;
    sputnik|sputnikglobe.com|sput|sputnic|sputinik|sputnik-news|sputniknews|spoutnik)
        WEBSITE="sputnikglobe.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/world/"
        )
        FILTERS=(
            "grep -E \"/[[:digit:]]+\""
            'grep -vE "privacy-policy"'
            'grep -vE "yandex.ru"'
        )
        ;;
    spnfa|spnfa.ir|sput-fa|sputnic-fa|sputnik-fa|sputnikfa|spntfa|spfa|spnt-fa|sputnik-farsi|sputnikfa.ir|sputnik-persian)
        WEBSITE="spnfa.ir"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/world/"
            "curl $CURL_OPTIONS $BASE_URL/iran/"
            "curl $CURL_OPTIONS $BASE_URL/opinion/"
            "curl $CURL_OPTIONS $BASE_URL/politics/"
            "curl $CURL_OPTIONS $BASE_URL/russia/"
            "curl $CURL_OPTIONS $BASE_URL/us/"
            "curl $CURL_OPTIONS $BASE_URL/keyword_sputnik_iran_exclusive/"
        )
        FILTERS=(
            "grep -E \"/[[:digit:]]+\""
            'grep -vE "yandex.ru"'
        )
        ;;
    iranintl|intl|iranintl.com|iran-intl|iraninternational|iranintl-news)
        WEBSITE="iranintl.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
        )
        FILTERS=(
            "grep -E \"/[[:digit:]]+\""
        )
        ;;
    bbc-farsi|bbcfarsi|bbcpersian|bbc-persian|bbcpersian.com|bbc-fa|bbcpersiannews|bbcpersian-news|bbc-farsi-news)
        WEBSITE="bbc.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/persian"
        )
        FILTERS=(
            'grep "articles"'
        )
        ;;
    msnbc|msnbc.com|msnbc-news|msnbcnews|msnbc-tv|msnbc-america)
        WEBSITE="msnbc.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
        )
        FILTERS=(
            'grep "msnbc.com/"'
            'grep -vE "archive|author|subscribe|#|/live|search|transcripts|schedule|accounts"'
            "grep -vE 'https?://www\.msnbc\.com/[^/]+(/[^/]+)?$'"
        )
        ;;
    cnn|cnn.com|cnn-news|cnnnews|cnn-international|cnni|cnn-intl)
        WEBSITE="cnn.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
        )
        FILTERS=(
            'grep "cnn.com/"'
            "grep -E 'cnn\\.com/[[:digit:]]{4}/[[:digit:]]{2}/[[:digit:]]{2}'"
        )
        ;;
    cna.asia|cna|cna.com|channelnewsasia.com|channelnewsasia|channelnews|cna-news|channelnews-asia|cna-asia|channelnewsasia-news)
        WEBSITE="www.channelnewsasia.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
        )
        FILTERS=(
            # "grep -E 'channelnewsasia\.com/(asia|cna-insider|commentary|east-asia|entertainment|singapore|sustainability|today|world)/'"
            "grep -E 'https?://(www\.)?channelnewsasia\.com/(asia|cna-insider|commentary|east-asia|entertainment|singapore|sustainability|world|big-read|up-close|voices)/[^/]+-[0-9]+'"
            "grep -v '/adulting'"
        )
        ;;
    reuters|reuters.com|reuters-news|reutersnews|reuter)
        WEBSITE="www.reuters.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/world/"
            "curl $CURL_OPTIONS $BASE_URL/business/"
            "curl $CURL_OPTIONS $BASE_URL/politics/"
        )
        FILTERS=(
            'grep -E "reuters\.com"'
            'grep -vE "video|videohub|lifestyle|authors|fund|sustainability|reutersone|dossier|article|section|topic|tag|topic|search|archive"'
        )
        ;;
    ap|apnews.com|ap-news|associated-press|ap-newscom|associatedpress)
        WEBSITE="apnews.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/hub/world-news"
            "curl $CURL_OPTIONS $BASE_URL/hub/politics"
            "curl $CURL_OPTIONS $BASE_URL/hub/business"
        )
        FILTERS=(
            'grep -E "/[0-9]{4}/[0-9]{2}/[0-9]{2}/"'
            'grep -vE "hub|tag|video|gallery|interactive|apnews-in|about|terms|privacy"'
        )
        ;;
    dw|dw.com|dw-world|dw-world.com|deutsche-welle)
        WEBSITE="www.dw.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/en/"
            "curl $CURL_OPTIONS $BASE_URL/en/top-stories/"
            "curl $CURL_OPTIONS $BASE_URL/en/news"
        )
        FILTERS=(
            'grep -E "/en/(top-stories|africa|asia|europe|latin-america|middle-east|north-america|germany|climate|health|human-rights|migration|technology|business|science|culture|news)/s-[0-9]+"'
            'grep -vE "video|audio|gallery|search|sitemap|subscribe|about|topic|category|academy|corporate|service|imprint|legal|privacy"'
        )
        ;;
    bbc|bbc.com|bbc-news|bbcnews|bbcworld|bbc-world)
        WEBSITE="www.bbc.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/news"
            "curl $CURL_OPTIONS $BASE_URL/news/world"
            "curl $CURL_OPTIONS $BASE_URL/news/politics"
            "curl $CURL_OPTIONS $BASE_URL/news/business"
            "curl $CURL_OPTIONS $BASE_URL/news/technology"
        )
        FILTERS=(
            'grep -E "/news/[^/]+/"'
            'grep -vE "live|video|audio|gallery|in-pictures|topics|sport|weather|account|preferences|contact|about"'
            'grep -vE "/news$|/news/[^/]*$|/news/uk$|/news/world$|/news/politics$|/news/business$|/news/technology$"'
        )
        ;;
    france24|france24.com|france-24|france-24-com|fr)
        WEBSITE="www.france24.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/en/"
            "curl $CURL_OPTIONS $BASE_URL/en/rss"
        )
        FILTERS=(
            'grep -E "/[0-9]{4}/[0-9]{2}/[0-9]{2}/|[0-9]{8}-"'
            'grep -vE "video|tag|author|sitemap|privacy|terms|newsletter|podcast"'
        )
        ;;
    abc|abc.com|abc-news|abcnews|abc-news-com)
        WEBSITE="abcnews.go.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/us"
            "curl $CURL_OPTIONS $BASE_URL/international"
            "curl $CURL_OPTIONS $BASE_URL/politics"
        )
        FILTERS=(
            'grep -E "/(story|article)/"'
            'grep -E "id="'
            'grep -vE "video|photo|gallery|tag|category|author|sitemap|privacy|terms|newsletter"'
        )
        ;;
    nhk|nhk.or.jp|nhk-world|nhkworld)
        WEBSITE="www3.nhk.or.jp"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/news/"
        )
        FILTERS=(
            'grep -E "nhk\.or\.jp/news/[en0-9]+\.html"'
            'grep -vE "index|archive|sitemap|about|contact"'
        )
        ;;
    sky|sky.com|sky-news|skynews|sky-com)
        WEBSITE="news.sky.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/news/world"
            "curl $CURL_OPTIONS $BASE_URL/news/politics"
        )
        FILTERS=(
            'grep -E "/story/"'
            'grep -E "[0-9]{7,}"'
            'grep -vE "video|live|watch|tv|radio|podcast|archive|sitemap|privacy|terms"'
        )
        ;;
    theguardian|theguardian.com|guardian|guardian-news|guardian-com)
        WEBSITE="www.theguardian.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/world"
            "curl $CURL_OPTIONS $BASE_URL/politics"
            "curl $CURL_OPTIONS $BASE_URL/business"
        )
        FILTERS=(
            'grep -E "/[0-9]{4}/[0-9]{2}/[0-9]{2}/"'
            'grep -vE "video|audio|gallery|info|about|help|preferences|email"'
        )
        ;;
    afp|afp.com|afpnews|afp-news|agence-france-presse)
        WEBSITE="www.afp.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/en"
        )
        FILTERS=(
            'grep -E "/[0-9]{4}/[0-9]{2}/[0-9]{2}/"'
            'grep -vE "page|category|author|search|sitemap|privacy|terms|newsletter"'
        )
        ;;
    trt|trtworld.com|trt-world|trt-world-com)
        WEBSITE="www.trtworld.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/news"
        )
        FILTERS=(
            'grep -E "/[0-9]{4}/[0-9]{2}/[0-9]{2}/"'
            'grep -vE "video|audio|gallery|author|category|tag|sitemap|privacy|terms"'
        )
        ;;
    cgtn|cgtn.com|cgtn-news|china-global-television-network)
        WEBSITE="www.cgtn.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
        )
        FILTERS=(
            'grep -E "/news/[0-9]{4}-[0-9]{2}-[0-9]{2}/"'
            'grep -vE "video|audio|gallery|section|author|tag|sitemap|privacy|terms|about"'
            'grep -vE "\.(jpg|jpeg|png|gif|svg|webp|bmp|ico)$"'
            'grep -vE "img/|\.jpeg|\.png|\.jpg"'
        )
        ;;
    aa|aa.com.tr|anadolu|anadolu-agency|anadoluagency)
        WEBSITE="www.aa.com.tr"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL/en"
        )
        FILTERS=(
            'grep -E "/[a-zA-Z]+/[0-9]{4}/[0-9]{2}/[0-9]{2}/[0-9]+.html"'
            'grep -vE "video|photo|sitemap|privacy|terms|about|contact|category"'
        )
        ;;
    aljazeera|aljazeera.com|aj|aljazeera-eng|aljazera|ajazeera|aljezera|aljazeerae|aljazer|aljazira|ajazera|aljazeeraeng)
        WEBSITE="aljazeera.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/news"
            "curl $CURL_OPTIONS $BASE_URL/news/latest"
        )
        FILTERS=(
            "grep -E '/(news|features|opinions|investigations|economy|middle-east|europe|asia-pacific|asia|latin-america|us-canada|africa)/|/[0-9]{4}/[0-9]{2}/[0-9]{2}/'"
            'grep -vE "liveblog|videos|gallery|podcasts|schedule|newsletters|sitemap|about-us|contact|careers|privacy|terms|code-of-ethics|user-accounts-help|stay-connected|travel|climate-crisis|learning|training|forum|doc|balkans|ajplus|aljazeera\.net|liberties|studies|hotels|commercial|cdn|static|google-analytics|chartbeat|ajiunit|mubasher|interactives|\.mp4|\.webm"'
            'grep -vE "/$"'
        )
        ;;
    cbs|cbsnews|cbsnews.com|cbs-news)
        WEBSITE="cbsnews.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/us"
            "curl $CURL_OPTIONS $BASE_URL/world"
            "curl $CURL_OPTIONS $BASE_URL/politics"
            "curl $CURL_OPTIONS $BASE_URL/business"
            "curl $CURL_OPTIONS $BASE_URL/technology"
            "curl $CURL_OPTIONS $BASE_URL/health"
            "curl $CURL_OPTIONS $BASE_URL/entertainment"
        )
        FILTERS=(
            'grep -E "cbsnews\.com/(news|us|world|politics|business|technology|health|entertainment)/[^/]+/"'
            'grep -vE "cbsnews\.com/(us/|world/|politics/|business/|technology/|health/|entertainment/)$"'
            'grep -vE "cbsnews\.com/(us|world|politics|business|technology|health|entertainment)/[0-9]+/"'
            'grep -vE "video|video-play|gallery|photos|tag|tags|author|search|sitemap|privacy|terms|newsletter|rss|watch|live|shows"'
        )
        ;;
    cnbc|cnbc.com|cnbc-news|cnbcnews)
        WEBSITE="cnbc.com"
        BASE_URL="https://${WEBSITE}"
        CURL_COMMANDS=(
            "curl $CURL_OPTIONS $BASE_URL"
            "curl $CURL_OPTIONS $BASE_URL/news"
            "curl $CURL_OPTIONS $BASE_URL/world"
            "curl $CURL_OPTIONS $BASE_URL/business"
            "curl $CURL_OPTIONS $BASE_URL/politics"
        )
        FILTERS=(
            'grep -E "cnbc\.com/[0-9]{4}/[0-9]{2}/[0-9]{2}/"'
            'grep -vE "video|video-play|gallery|photos|tag|tags|author|search|sitemap|privacy|terms|newsletter|rss|quotes|symbols|quotes\.html"'
        )
        ;;
    *)
        CURL_COMMANDS=("curl $CURL_OPTIONS $BASE_URL")
        FILTERS=()
        if $VERBOSE; then
            echo "Website '$WEBSITE' not specifically configured. Using default settings."
        fi
        ;;
esac

# Build the pipeline
PIPELINE="( "
for i in "${!CURL_COMMANDS[@]}"; do
    PIPELINE+="${CURL_COMMANDS[$i]}"
    if [ $i -lt $((${#CURL_COMMANDS[@]} - 1)) ]; then
        PIPELINE+="; "
    else
        PIPELINE+=" "
    fi
done
PIPELINE+=") | $URLS_CMD $BASE_URL | sort -u"
for filter in "${FILTERS[@]}"; do
    PIPELINE+=" | $filter"
done
PIPELINE+=" | grep -vE \"${EXCLUDE_REGEX}\""
# PIPELINE+=" | grep -v \"${BASE_URL}\""
PIPELINE+=" | grep -v \"://cdn.${WEBSITE}\""

# Display the pipeline if verbose mode is enabled
if $VERBOSE; then
    echo "Executing: $PIPELINE"
fi

# Execute the pipeline
eval "$PIPELINE"
