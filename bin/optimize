#!/bin/bash

cache_dir="$HOME/.cache/cleaner";
bleaching=true;
trim=false;
update=false;

function print_help {
    echo "Clean unseless things."
    echo "$0"
    echo "    -t|--trim      # run fstrim service to trim SSDs"
    echo "    -u|--update    # update the system before cleaning"
    echo "    --no-bleaching # don't run bleachbit"
    echo "    --no-trim      # don't trim"
    echo "    --no-update    # don't update"
    exit 0;
}

while getopts ":htu-:" opt; do
  case $opt in
    t) trim=true;;
    u) update=true;;
    h) print_help;;
    -)
      case "$OPTARG" in
        no-bleaching) bleaching=false;;
        bleaching) bleaching=true;;
        trim) trim=true;;
        update) update=true;;
        no-trim) trim=false;;
        no-update) update=false;;
        help) print_help;;
        *) echo "Invalid option: --$OPTARG" >&2
           exit 1
           ;;
      esac
      ;;
    \?) echo "Invalid option: -$OPTARG" >&2
        exit 1
        ;;
  esac
done
shift $((OPTIND-1))

mkdir -p "$cache_dir";

if $update; then
    echo "Updating:";
    if command -v yay >/dev/null; then
        yay -Syu --noconfirm 2>&1 | tee "$cache_dir/update.log";
    elif command -v pacman >/dev/null; then
        sudo pacman -Syu --noconfirm 2>&1 | tee "$cache_dir/update.log";
    else
        echo "Bleachbit is not installed.";
        exit 1;
    fi
fi

if $bleaching; then
    echo "Bleaching:";
    if ! command -v bleachbit >/dev/null; then
        echo "Bleachbit is not installed.";
        exit 1;
    fi
    bleachbit --clean --preset 2>&1 | tee "$cache_dir/bleachbit.log";
    sudo -E bleachbit --clean --preset 2>&1 | tee "$cache_dir/bleachbit-semi-root.log";
fi

if $trim; then
    echo "Trimming:";
    if ! sudo systemctl list-unit-files | grep "^fstrim" >/dev/null; then
        echo "Bleachbit is not installed.";
        exit 1;
    fi
    sudo systemctl restart fstrim
    sudo systemctl status fstrim 2>&1 | tee "$cache_dir/fstrim.log";
fi

