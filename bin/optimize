#!/bin/bash

if [[ -t 1 ]]; then
    C_RESET=$'[0m'
    C_INFO=$'[1;34m'
    C_WARN=$'[1;33m'
else
    C_RESET=''
    C_INFO=''
    C_WARN=''
fi

cache_dir="$HOME/.config/optimize";
bleaching=false;
trim=false;
update=false;
empty_trash=false;
remove_update_cache=false;
go_cache=false;

warn() {
    echo "${C_WARN}WARNING:${C_RESET} $*" >&2
}

function print_help {
    echo "Clean useless things."
    echo "$0"
    echo "    -t|--trim           # run fstrim service to trim SSDs"
    echo "    -u|--update         # update the system before cleaning"
    echo "    -b|--bleach         # remove useless files using bleachbit"
    echo "    -e|--empty-trash    # empty all user's trashes"
    echo "    -c|--clean-update   # remove update cache"
    echo "    -g|--clean-go       # remove go language cache"
    echo "    --no-bleaching      # don't run bleachbit"
    echo "    --no-trim           # don't trim"
    echo "    --no-update         # don't update"
    echo "    --no-trash          # don't clean trashes"
    exit 0;
}

while getopts ":hbetucg-:" opt; do
  case $opt in
    t) trim=true;;
    e) empty_trash=true;;
    u) update=true;;
    b) bleaching=true;;
    c) remove_update_cache=true;;
    g) go_cache=true;;
    h) print_help;;
    -)
      case "$OPTARG" in
        no-bleaching) bleaching=false;;
        bleaching|bleach|clean|clear) bleaching=true;;
        trim) trim=true;;
        empty-trash|empty|trash|clear-trash|clean-trash) empty_trash=true;;
        go-cache|clean-go|go-clean) go_cache=true;;
        no-trash|no-empty-trash|no-empty-trashes) empty_trash=false;;
        update) update=true;;
        no-trim) trim=false;;
        no-update) update=false;;
        help) print_help;;
        *) echo "Invalid option: --$OPTARG" >&2
           exit 1
           ;;
      esac
      ;;
    \?) echo "Invalid option: -$OPTARG" >&2
        exit 1
        ;;
  esac
done
shift $((OPTIND-1))

mkdir -p "$cache_dir";

if $empty_trash; then
    if command -v trash-empty >/dev/null; then
        echo "${C_INFO}Clearing Trash:${C_RESET}";
        trash-list --all-users 2>&1 | tee "$cache_dir/trash.log";
        trash-empty --all-users -f;
    else
        warn "trash-empty command not found; skipping trash cleanup."
    fi
fi

if $update; then
    echo "${C_INFO}Updating:${C_RESET}";
    if command -v yay >/dev/null; then
        yay -Syu --noconfirm 2>&1 | tee "$cache_dir/update.log";
    elif command -v pacman >/dev/null; then
        sudo pacman -Syu --noconfirm 2>&1 | tee "$cache_dir/update.log";
    elif command -v apt >/dev/null; then
        sudo apt update -y;
        export DEBIAN_FRONTEND=noninteractive;
        sudo -E apt-get -o Dpkg::Options::="--force-confold" -o Dpkg::Options::="--force-confdef" dist-upgrade -q -y --allow-downgrades --allow-remove-essential --allow-change-held-packages;
    else
        warn "No supported package manager found (yay, pacman, apt); skipping updates."
    fi

    if command -v flatpak >/dev/null; then
        echo
        echo
        echo
        echo "${C_INFO}Update Flatpak:${C_RESET}"
        flatpak update --noninteractive --assumeyes 2>&1 | tee "$cache_dir/update-flatpak.log";
    fi
fi

if $bleaching; then
    if command -v bleachbit >/dev/null; then
        echo "${C_INFO}Bleaching:${C_RESET}";
        # bleachbit --clean --preset 2>&1 | tee "$cache_dir/bleachbit.log";
        sudo -E bleachbit --clean --preset 2>&1 | tee "$cache_dir/bleachbit-semi-root.log";
    else
        warn "bleachbit command not found; skipping bleaching."
    fi
fi

if $trim; then
    echo "${C_INFO}Trimming:${C_RESET}";
    if ! command -v systemctl >/dev/null; then
        warn "systemctl command not found; skipping trim."
    elif ! sudo systemctl list-unit-files | grep "^fstrim" >/dev/null; then
        warn "fstrim service/timer not found; skipping trim."
    else
        sudo systemctl restart fstrim
        sudo systemctl status fstrim 2>&1 | tee "$cache_dir/fstrim.log";
    fi
fi

if $remove_update_cache; then
    if command -v yay >/dev/null; then
        yes | yay -Scc 2>&1 | tee "$cache_dir/update-clean.log";
    elif command -v pacman >/dev/null; then
        yes | sudo pacman -Scc 2>&1 | tee "$cache_dir/update-clean.log";
    else
        warn "No supported package manager found for cache cleanup (yay, pacman)."
    fi
fi

if $go_cache; then
    if command -v go >/dev/null; then
        go clean -cache
        go clean -modcache
        sudo go clean -cache
        sudo go clean -modcache
    else
        warn "go command not found; skipping Go cache cleanup."
    fi
fi
