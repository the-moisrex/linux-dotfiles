version: "3.9"

services:
  it-tools:
    image: corentinth/it-tools
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ittools.entrypoints=web"
      - >
        traefik.http.routers.ittools.rule=
        Host(`tools.localhost`)
        || Host(`it.localhost`)
        || Host(`it-tools.localhost`)
      - "traefik.http.services.ittools.loadbalancer.server.port=80"
    restart: unless-stopped

  code-server:
    image: codercom/code-server
    environment:
      PASSWORD: dev
    volumes:
      - code-data:/home/coder
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.code.entrypoints=web"
      - >
        traefik.http.routers.code.rule=
        Host(`code.localhost`)
        || Host(`vscode.localhost`)
      - "traefik.http.services.code.loadbalancer.server.port=8080"
    restart: unless-stopped

  gitea:
    image: gitea/gitea
    environment:
      USER_UID: 1000
      USER_GID: 1000
    volumes:
      - gitea-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.entrypoints=web"
      - >
        traefik.http.routers.gitea.rule=
        Host(`git.localhost`)
        || Host(`gitea.localhost`)
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"
    restart: unless-stopped

  # Minimal Sentry services
  sentry-postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: sentry
      POSTGRES_PASSWORD: sentry
      POSTGRES_DB: sentry
    volumes:
      - sentry-postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  sentry-redis:
    image: redis:alpine
    restart: unless-stopped

  sentry-web:
    image: sentry:latest
    depends_on:
      - sentry-postgres
      - sentry-redis
    environment:
      SENTRY_POSTGRES_HOST: sentry-postgres
      SENTRY_POSTGRES_PORT: 5432
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: sentry
      SENTRY_REDIS_HOST: sentry-redis
      SENTRY_REDIS_PORT: 6379
      SENTRY_SECRET_KEY: changeme
      SENTRY_FILESTORE_DIR: /var/lib/sentry/files
    volumes:
      - sentry-data:/var/lib/sentry
    ports:
      - "9000:9000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sentry.entrypoints=web"
      - "traefik.http.routers.sentry.rule=Host(`sentry.localhost`)"
      - "traefik.http.services.sentry.loadbalancer.server.port=9000"
    command: sh -c "sentry upgrade --noinput && sentry createuser --email admin@example.com --password toor --superuser --no-password || true && sentry run web"
    restart: unless-stopped

volumes:
  code-data:
  gitea-data:
  sentry-data:
  sentry-postgres-data:

